<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesquisa de Rede</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='image/LogoProjeto.ico') }}">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
  <style>

    .node circle {
      stroke: #fff;
      stroke-width: 1.5px;
    }
    .node text {
      font: 10px sans-serif;
      pointer-events: none;
    }
    .link {
      fill: none;
      stroke: #999;
      stroke-opacity: 0.6;
    }
    svg {
      border: 1px solid #ddd;
      margin-top: 20px;
      width: 100%;
      height: 600px;
    }
  </style>
</head>
<body>
  <!-- Navbar (Header) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <!-- T√≠tulo -->
      <a class="navbar-brand" href="#"></a>
      <!-- Logos -->
      <a class="navbar-brand" href="/">
        <img src="{{ url_for('static', filename='image/logo-uerr2.png') }}" alt="Logo UERR" width="150" height="40" class="d-inline-block align-text-top">
      </a>
      <a class="navbar-brand" href="/">
        <img src="{{ url_for('static', filename='image/Logo Ci√™ncia da Computa√ß√£o UERR Horizontal sem fundo.png') }}" alt="Logo Ci√™ncia da Computa√ß√£o" width="150" height="40" class="d-inline-block align-text-top">
      </a>
      <!-- Bot√£o de toggler -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <!-- Itens de navega√ß√£o -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link active" href="#">In√≠cio</a>
          </li>
          <li class="nav-item">
            <!-- "Sobre" abre um modal com o objetivo do sistema -->
            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#aboutModal">Sobre</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Conte√∫do Principal -->
  <div class="container mt-5">
    <div class="row">
      <div class="col-md-8 offset-md-2">
        <div class="text-center">
          <img src="{{ url_for('static', filename='image/LogoProjeto.png') }}" class="rounded" alt="..." height="120">
        </div>
        <h1 class="text-center mb-4">Pesquisa de Rede</h1>
        <form id="searchForm">
          <!-- Input group moderno com bot√µes integrados -->
          <div class="input-group mb-3">
            <input type="text" class="form-control" id="query" placeholder="Digite o nome ou CPF" aria-label="Nome ou CPF">
            <button class="btn btn-outline-primary" type="submit">Pesquisar üîé</button>
            <button class="btn btn-outline-success" type="button" id="generateReport">Relat√≥rio üìë</button>
          </div>
        </form>
      </div>
    </div>

    <!-- √Årea para renderizar o grafo -->
    <div class="row">
      <div class="col-12">
        <svg id="graph"></svg>
      </div>
    </div>
  </div>

  <!-- Modal para sele√ß√£o do n√≠vel de pesquisa -->
  <div class="modal fade" id="searchLevelModal" tabindex="-1" aria-labelledby="searchLevelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="searchLevelModalLabel">Selecione o N√≠vel de Pesquisa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Deseja pesquisar com n√≠vel 1 ou n√≠vel 2?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-primary" id="modalLevel1" data-level="1">N√≠vel 1</button>
          <button type="button" class="btn btn-outline-primary" id="modalLevel2" data-level="2">N√≠vel 2</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Sobre -->
  <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="aboutModalLabel">Sobre</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>
            O <strong>Grupo de Pesquisa</strong> da <strong>Universidade Estadual de Roraima (UERR)</strong> desenvolveu este sistema com o objetivo de 
            facilitar a an√°lise de redes de conex√µes em atos administrativos, permitindo a identifica√ß√£o de relacionamentos e padr√µes 
            que possam contribuir para a investiga√ß√£o de poss√≠veis irregularidades.
        </p>
        <p>
            O projeto √© conduzido pelos professores orientadores:
            <ul>
                <li><strong>Dr. Bruno C√©sar Barreto de Figueir√™do <a id="modalActArquivo" href="http://buscatextual.cnpq.br/buscatextual/visualizacv.do?metodo=apresentar&id=K4482716E8" target="_blank">LATTES</a> </strong></li>
                <li><strong>Mestre Francisco Carlos de Lima Pereira <a id="modalActArquivo" href="http://buscatextual.cnpq.br/buscatextual/visualizacv.do?metodo=apresentar&id=K4732802J0" target="_blank">LATTES</a></strong></li>
            </ul>
        </p>
        <p>
            Estudantes pesquisadores envolvidos no projeto:
            <ul>
                <li><strong>Breno Nascimento</strong></li>
                <li><strong>Gabriela Monteiro</strong></li>
                <li><strong>Larisa</strong></li>
                <li><strong>Matheus Vicente</strong></li>
            </ul>
        </p>
    </div>
          <!-- Voc√™ pode personalizar essa mensagem conforme necess√°rio -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
  <!-- D3.js -->
  <script src="{{ url_for('static', filename='js/d3.min.js') }}"></script>
  <!-- Bootstrap JS -->
  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script>
    $(document).ready(function () {
      const svg = d3.select("#graph");
      const width = parseInt(svg.style("width"));
      const height = parseInt(svg.style("height"));

      let simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2));

      let zoom = d3.zoom()
        .on("zoom", (event) => {
          svg.select("g.graph-container").attr("transform", event.transform);
        });

      svg.call(zoom);

      const graphContainer = svg.append("g")
        .attr("class", "graph-container");

      // Fun√ß√£o para carregar dados do grafo
      function loadGraph(level) {
        const query = $('#query').val();

        if (!query) {
          alert('Por favor, insira um nome ou CPF.');
          return;
        }

        $.post('/search', { query: query, level: level }, function (data) {
          if (data.graph_data) {
            const { nodes, links } = data.graph_data;

            graphContainer.selectAll("*").remove(); // Limpa o grafo anterior

            simulation.stop(); // Para a simula√ß√£o anterior

            simulation = d3.forceSimulation() // Reinicia a simula√ß√£o
              .force("link", d3.forceLink().id(d => d.id).distance(100))
              .force("charge", d3.forceManyBody().strength(-300))
              .force("center", d3.forceCenter(width / 2, height / 2));

            const link = graphContainer.append("g")
              .attr("class", "links")
              .selectAll("line")
              .data(links)
              .join("line")
              .attr("class", "link")
              .style("stroke-width", 1.5);

            const node = graphContainer.append("g")
              .attr("class", "nodes")
              .selectAll("g")
              .data(nodes)
              .join("g")
              .attr("class", "node");

            node.append("circle")
              .attr("r", 5)
              .attr("fill", d => d.type === "Pessoa" ? "#ff7f0e" : "#1f77b4");

            node.append("text")
              .text(d => d.label)
              .attr("x", 8)
              .attr("y", 3);

            simulation
              .nodes(nodes)
              .on("tick", ticked);

            simulation.force("link").links(links);

            function ticked() {
              link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

              node
                .attr("transform", d => `translate(${d.x},${d.y})`);
            }
          } else {
            alert('Nenhum resultado encontrado.');
          }
        }).fail(function (xhr) {
          const error = xhr.responseJSON?.error || 'Erro desconhecido.';
          alert(error);
        });
      }

      // Ao submeter o formul√°rio, exibe o modal para sele√ß√£o do n√≠vel
      $('#searchForm').submit(function (e) {
        e.preventDefault();
        $('#searchLevelModal').modal('show');
      });

      // Eventos para os bot√µes do modal de sele√ß√£o de n√≠vel
      $('#modalLevel1, #modalLevel2').click(function () {
        const level = $(this).data('level');
        $('#searchLevelModal').modal('hide');
        loadGraph(level);
      });

      // Gera√ß√£o do Relat√≥rio: redireciona para /report passando o par√¢metro de consulta
      $('#generateReport').click(function () {
        const query = $('#query').val();

        if (!query) {
          alert('Por favor, insira um nome ou CPF antes de gerar o relat√≥rio.');
          return;
        }

        window.location.href = `/report?query=${encodeURIComponent(query)}`;
      });
    });
  </script>
</body>
</html>
